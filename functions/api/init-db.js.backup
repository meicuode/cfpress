/**
 * æ•°æ®åº“åˆå§‹åŒ– API
 * GET /api/init-db - åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
 *
 * ä½¿ç”¨ batch ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰ SQL è¯­å¥ï¼ˆå¸¦äº‹åŠ¡ï¼‰
 * å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
 */

export async function onRequestGet(context) {
  const { env } = context;

  try {
    // è¯»å–å®Œæ•´çš„ schema.sql å†…å®¹
    const schemaSQL = `SCHEMA_CONTENT_PLACEHOLDER`;

    console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');

    // åˆ†å‰² SQL è¯­å¥
    const statements = schemaSQL
      .split(';')
      .map(s => s.trim())
      .filter(s => s.length > 0 && !s.startsWith('--'));

    console.log(`ğŸ“ å‡†å¤‡æ‰§è¡Œ ${statements.length} æ¡ SQL è¯­å¥`);

    // ä½¿ç”¨ batch æ‰§è¡Œæ‰€æœ‰è¯­å¥ï¼ˆè‡ªåŠ¨ä½¿ç”¨äº‹åŠ¡ï¼‰
    const batch = statements.map(stmt => env.DB.prepare(stmt));
    const results = await env.DB.batch(batch);

    console.log(`âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼Œæ‰§è¡Œäº† ${results.length} æ¡è¯­å¥`);

    return new Response(
      JSON.stringify({
        success: true,
        message: `æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼Œæ‰§è¡Œäº† ${results.length} æ¡ SQL è¯­å¥`,
        statements_count: results.length,
        note: 'æ­¤æ¥å£ä»…ç”¨äºå¼€å‘ç¯å¢ƒ'
      }),
      {
        headers: { 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);

    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
        message: 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œäº‹åŠ¡å·²å›æ»š'
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      }
    );
  }
}
